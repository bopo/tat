#!/bin/bash
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
source $DIR/../common.inc
this=`basename $0`

export nodepath=$1
[ -z $nodepath ] && error_exit "$this: missing nodepath"
[ -e $nodepath/.conf/nickname ] || error_exit "$this: $nodepath is not a node"

error_msg="$this: missing key, abort"
execute=`get_node_key_path $nodepath tat_execute` || error_exit "$error_msg"
copy=`get_node_key_path $nodepath tat_copy` || error_exit "$error_msg"
nickname=`get_node_key_value $nodepath nickname` || error_exit "$error_msg"
remote_pid_path=`get_node_key_value $nodepath pidPath` || error_exit "$error_msg"
remote_base_path=`get_node_key_value $nodepath installPath` || error_exit "$error_msg"
remote_service_path=`get_node_key_value $nodepath serviceFilePath` || error_exit "$error_msg"
remote_torrc_path=`get_node_key_value $nodepath torrcFilePath` || error_exit "$error_msg"
remote_etc_path=`get_node_key_value $nodepath etcPath` || error_exit "$error_msg"

#generate config and service
$BASEDIR/lib/node/generate_node_conf $nodepath || error_exit "$this: could not generate configuration"

#the deploy path should be generated by the above generate_node_conf
deploy_path=$nodepath/.deploy/etc
[ -d "$deploy_path" ] || error_exit "$this: $deploy_path does not exist!"

torrc_path=$deploy_path/tor-$nickname.rc
service_path=$deploy_path/service-tor-$nickname.sh


#Copy torrc and service

if $execute "cat $remote_torrc_path 2>/dev/null" | diff $torrc_path - &>/dev/null ;then
    log "$this: torrc unchanged" 3
else
    log "$this: torrc changed, updating" 3
    $copy $torrc_path $remote_torrc_path || error_exit "$this: could not copy $torrc_path to $remote_torrc_path"
    reload="yes"
fi

if $execute "cat $remote_service_path 2>/dev/null" | diff $service_path - &>/dev/null ;then
    log "$this: service unchanged" 3
else
    log "$this: service changed, updating" 3
    $copy $service_path $remote_service_path || error_exit "$this: could not copy $service_path to $remote_service_path"
    reload="yes"
fi

#Make service script executable
remote_service_path=$remote_etc_path/service-tor-$nickname.sh
$execute "chmod a+x $remote_service_path" || error_exit "$this: could not change permissions to $remote_service_path"


if [ "$reload" == "yes" ]; then
    if $BASEDIR/lib/node/status_node $nodepath; then
        #reload tor daemon with SIGHUP
        $BASEDIR/lib/node/manage_node $nodepath reload || error_exit "$this: could not reload tor"
    else
        log "$this: node not running, start with './tat start $nodepath'" 2
    fi
fi

log "$this: finished $nodepath" 1
